# cloudbuild.yaml：构建 + 测试 + 推送
steps:
  # 步骤 1：安装所有依赖（包括开发依赖，用于测试）
  - name: "node:18-alpine" # 使用 Node.js 18 镜像执行 npm 命令
    args: ["npm", "install"] # 安装依赖
    id: "install-dependencies"
    dir: "." # 执行目录（项目根目录）
    env:
      - "NODE_ENV=development" # 开发环境，安装 devDependencies

  # 步骤 2：执行单元测试（测试失败则构建终止）
  - name: "node:18-alpine"
    args: ["npm", "test"] # 执行测试脚本
    id: "run-tests"
    dir: "."
    waitFor: ["install-dependencies"] # 依赖前一步安装依赖

  # 步骤 3：构建 Docker 镜像（使用提交哈希作为标签，避免重复）
  - name: "gcr.io/cloud-builders/docker"
    args: [
        "build",
        "-t",
        "gcr.io/${PROJECT_ID}/my-node-app:latest", # 同时打 latest 标签
        ".",
      ]
    id: "build-docker-image"
    waitFor: ["run-tests"] # 测试通过后才构建镜像

  # 步骤 4：推送镜像到 GCR
  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/${PROJECT_ID}/my-node-app:latest"]
    id: "push-latest"
    waitFor: ["build-docker-image"]

  # 步骤 5：连接 GKE 集群（获取 kubectl 配置）
  - name: "gcr.io/cloud-builders/gcloud"
    args: [
        "container",
        "clusters",
        "get-credentials",
        "my-gke-cluster",
        "--region",
        "asia-east1", # 集群所在区域（与创建时一致）
        "--project",
        "${PROJECT_ID}",
      ]
    id: "connect-gke-cluster"
    waitFor: ["push-latest"] # 镜像推送完成后再连接

  # 步骤 6：部署到 GKE（应用 K8s 配置）
  - name: "gcr.io/cloud-builders/kubectl"
    args: [
        "apply",
        "-f",
        "k8s/deployment.yaml", # K8s 配置文件路径
      ]
    id: "deploy-to-gke"
    waitFor: ["connect-gke-cluster"]
    env:
      # 传递变量到 kubectl，让 deployment.yaml 能引用
      - "PROJECT_ID=${PROJECT_ID}"
      - "KUBECONFIG=/workspace/.kube/config" # kubectl 配置路径（Cloud Build 自动生成）

logs_bucket: "gs://hadoop-proj-001-cloudbuild-logs"

# 声明输出镜像（两个标签）
images:
  - "gcr.io/${PROJECT_ID}/my-node-app:latest"

timeout: "900s"
